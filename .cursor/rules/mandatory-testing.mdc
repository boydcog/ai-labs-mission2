# 필수 테스트 규칙

**⚠️ 가장 중요한 규칙**: 모든 코드 변경 후에는 반드시 테스트를 실행해야 합니다.

## 개요

이 규칙은 다음 두 가지 필수 사항을 정의합니다:
1. **코드 변경 후 무조건 테스트 실행**
2. **코드 수정 시 관련 테스트도 함께 수정**

## 핵심 원칙

### 1. 코드 변경 후 무조건 테스트 실행 (최우선)
**모든 코드 파일 변경 후 반드시 다음 순서로 실행:**

```bash
# 1. Lint 검사 (warning도 오류로 처리)
pnpm lint

# 2. Type Check
pnpm type-check

# 3. Build 검증 (warning 없이 성공해야 함)
pnpm build

# 4. 테스트 실행 (작업 유형에 따라 선택)
# - 컴포넌트 생성/수정 시: pnpm test:component
# - 페이지 생성/수정 시: pnpm test
```

**테스트 종류:**
- **`pnpm test`**: 페이지 테스트 (일반 프로젝트 테스트)
  - 페이지 개발 후 실행
  - 컴포넌트 테스트는 제외 (컴포넌트는 안정되어 있다고 가정)
  - `tests/pages/` 디렉토리의 테스트 실행

- **`pnpm test:component`**: 컴포넌트 테스트
  - 프로젝트 템플릿의 기본 컴포넌트가 잘 구현되었는지 확인
  - 컴포넌트 생성/수정 시에만 실행
  - `tests/visual/` 디렉토리의 테스트 실행

**실행 시점:**
- 파일 저장 후 즉시 실행
- 커밋 전 반드시 실행
- PR 생성 전 반드시 실행
- 코드 변경이 완료되었다고 판단되는 시점에 즉시 실행

**테스트 실패 시:**
- 테스트가 실패하면 코드 변경을 완료로 간주하지 않음
- 모든 테스트가 통과할 때까지 수정 및 재실행
- 테스트 실패 원인을 분석하고 해결

**테스트 통과 기준:**
- ✅ Lint: 오류 및 warning 없음 (`--max-warnings 0`)
- ✅ Type Check: 타입 오류 및 warning 없음
- ✅ Build: 빌드 성공, warning 없음
- ✅ Playwright Test: 모든 테스트 통과
  - 컴포넌트 테스트: `pnpm test:component` (컴포넌트 생성/수정 시)
  - 페이지 테스트: `pnpm test` (페이지 생성/수정 시)

### 2. 코드 수정 = 테스트 수정
**모든 코드 변경은 관련 테스트도 함께 수정해야 합니다.**

- 컴포넌트 수정 → 해당 컴포넌트 테스트 수정
- 타입 변경 → 관련 테스트 타입 수정
- API 변경 → 관련 테스트 케이스 수정
- 스토리 변경 → 관련 테스트 경로/선택자 수정

### 3. 테스트 실행 예외

**예외 없음**: 모든 코드 변경에 대해 테스트를 실행해야 합니다.

다음의 경우에도 테스트 실행:
- 단순 주석 추가/수정
- 타입 정의만 변경
- 설정 파일 변경
- 문서 파일 변경

### 4. 테스트 실행 시 에러/경고 처리

테스트 실행 후 발생한 에러나 경고는 반드시 기록하고 해결해야 합니다:

1. **에러 발생 시**:
   - 에러 메시지 전체 기록
   - 원인 분석
   - 수정 후 재테스트

2. **경고 발생 시**:
   - 경고 메시지 기록
   - 영향도 평가
   - 필요시 해결

3. **테스트 실패 시**:
   - 실패한 테스트 케이스 확인
   - 테스트 리포트 확인 (`playwright-report/index.html`)
   - 원인 분석 및 수정
   - 재테스트

자세한 내용은 `.cursor/rules/test-errors-checklist.mdc`를 참고하세요.

## 코드 수정 시 체크리스트

### 컴포넌트 수정 시

1. **컴포넌트 파일 수정**
   - [ ] 컴포넌트 로직/스타일 변경
   - [ ] 타입 정의 변경 (필요시)

2. **관련 파일 확인**
   - [ ] `{ComponentName}.stories.tsx` - 스토리 경로/이름 확인
   - [ ] `tests/visual/{componentname}.spec.ts` - 테스트 파일 확인
   - [ ] 다른 컴포넌트에서 사용하는 경우 영향 범위 확인

3. **테스트 파일 수정**
   - [ ] 스토리 경로가 변경된 경우 테스트 경로 수정
   - [ ] 컴포넌트 props/속성이 변경된 경우 선택자 수정
   - [ ] 새로운 variant/status 추가 시 테스트 케이스 추가
   - [ ] 제거된 variant/status에 대한 테스트 제거

4. **검증 실행**
   - [ ] `pnpm lint` 실행
   - [ ] `pnpm type-check` 실행
   - [ ] `pnpm build` 실행
   - [ ] `pnpm test` 실행 (모든 테스트 통과 확인)

### 스토리 파일 수정 시

1. **스토리 파일 수정**
   - [ ] 스토리 이름 변경 (`export const StoryName`)
   - [ ] 스토리 경로 변경 (`title: 'Category/Component'`)
   - [ ] 스토리 args 변경

2. **테스트 파일 수정**
   - [ ] Storybook URL 경로 수정
     - `title: 'Components/Default/Button'` → `/story/components-default-button--default`
     - `title: 'Design System/Character'` → `/story/design-system-character--thumbnail`
   - [ ] 스토리 이름이 변경된 경우 테스트 경로 수정
   - [ ] 스토리 내용이 변경된 경우 선택자/검증 로직 수정

3. **검증 실행**
   - [ ] `pnpm test` 실행하여 해당 테스트 통과 확인

### 타입 정의 수정 시

1. **타입 파일 수정**
   - [ ] `{ComponentName}.types.ts` 수정

2. **관련 파일 확인**
   - [ ] 컴포넌트 파일에서 타입 사용 확인
   - [ ] 스토리 파일에서 타입 사용 확인
   - [ ] 테스트 파일에서 타입 사용 확인

3. **테스트 수정 (필요시)**
   - [ ] 타입 변경으로 인한 테스트 로직 수정
   - [ ] 새로운 타입 값에 대한 테스트 추가

4. **검증 실행**
   - [ ] `pnpm type-check` 실행
   - [ ] `pnpm test` 실행

## 테스트 실패 시 대응 절차

### 1. 실패 원인 분석

```bash
# 상세한 테스트 결과 확인
pnpm test 2>&1 | tee test-output.log

# 특정 테스트만 실행
pnpm exec playwright test tests/visual/assistchip.spec.ts
```

### 2. 일반적인 실패 원인

#### Storybook 경로 불일치
- **증상**: `element(s) not found`, `Timeout`
- **원인**: 스토리 경로가 변경되었거나 잘못됨
- **해결**: 
  1. 실제 Storybook에서 스토리 경로 확인
  2. 테스트 파일의 `gotoStory()` 경로 수정
  3. Storybook URL 형식: `title`을 소문자로, 공백을 하이픈으로 변환

#### 선택자 불일치
- **증상**: `element(s) not found`
- **원인**: 컴포넌트의 data 속성 또는 클래스가 변경됨
- **해결**:
  1. 실제 렌더링된 HTML 확인 (브라우저 개발자 도구)
  2. 테스트 선택자 수정
  3. 컴포넌트에 `data-testid` 추가 (권장)

#### 로딩 타이밍 문제
- **증상**: `Timeout`, 간헐적 실패
- **원인**: Storybook이 완전히 로드되기 전에 요소 찾기 시도
- **해결**:
  1. `helpers.ts`의 `waitForStorybook()` 함수 확인
  2. 테스트에 추가 대기 시간 추가
  3. `await expect(element).toBeVisible()` 사용

#### 값 불일치
- **증상**: `Expected: X, Received: Y`
- **원인**: 컴포넌트 동작이 변경되었거나 테스트 기대값이 잘못됨
- **해결**:
  1. 실제 컴포넌트 동작 확인
  2. 테스트 기대값 수정 또는 컴포넌트 수정

### 3. 수정 및 재검증

1. 원인 파악 후 수정
2. `pnpm test` 재실행
3. 모든 테스트 통과 확인
4. 실패 시 1단계로 돌아가기

## Storybook 경로 변환 규칙

### Title → URL 경로 변환

```
Title: 'Components/Default/Button'
→ URL: '/story/components-default-button--default'

Title: 'Design System/Character'
→ URL: '/story/design-system-character--thumbnail'

규칙:
1. 소문자로 변환
2. 공백을 하이픈(-)으로 변환
3. 슬래시(/)를 하이픈(-)으로 변환
4. 스토리 이름 추가: --{storyName} (소문자, 카멜케이스 → 케밥케이스)
```

### 예시

```typescript
// Storybook 스토리
title: 'Components/Default/AssistChip'
export const Default: Story = { ... }
export const Statuses: Story = { ... }

// 테스트 경로
await gotoStory(page, '/story/components-default-assistchip--default');
await gotoStory(page, '/story/components-default-assistchip--statuses');
```

## 자동화 규칙

### 코드 수정 시 자동 확인 사항

1. **컴포넌트 파일 수정 감지**
   - `src/components/default/{ComponentName}/{ComponentName}.tsx` 수정
   - → `tests/visual/{componentname}.spec.ts` 확인 및 수정 필요

2. **스토리 파일 수정 감지**
   - `src/components/default/{ComponentName}/{ComponentName}.stories.tsx` 수정
   - → `tests/visual/{componentname}.spec.ts` 경로/선택자 확인 및 수정 필요

3. **타입 파일 수정 감지**
   - `src/components/default/{ComponentName}/{ComponentName}.types.ts` 수정
   - → 관련 테스트 파일 확인 및 수정 필요

## 금지 사항

- ❌ 테스트를 실행하지 않고 코드 변경 완료로 간주
- ❌ 테스트 실패를 무시하고 커밋
- ❌ 테스트를 주석 처리하거나 스킵
- ❌ 코드만 수정하고 테스트는 수정하지 않음
- ❌ 스토리 경로 변경 시 테스트 경로 미수정

## 예외 사항

다음의 경우에만 테스트 수정을 생략할 수 있습니다:

1. **문서/주석만 수정**: 기능 변경 없음
2. **타입 정의 추가 (기존 동작 유지)**: 새로운 타입만 추가하고 기존 동작 변경 없음
3. **테스트 파일 자체 수정**: 테스트 로직만 개선, 코드 변경 없음

단, 예외 사항이라도 `pnpm test`는 반드시 실행하여 기존 테스트가 통과하는지 확인해야 합니다.

## 위반 시

테스트를 실행하지 않고 코드 변경을 완료로 간주하지 않습니다.
사용자에게 테스트 실행을 요청하거나 자동으로 실행해야 합니다.

## 관련 규칙

- `.cursor/rules/code-standards.mdc` - 코드 품질 및 검증 규칙
- `.cursor/rules/component-usage.mdc` - 컴포넌트 사용 규칙
- `.cursor/rules/test-errors-checklist.mdc` - 테스트 에러 및 경고 체크리스트
